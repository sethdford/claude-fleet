# ═══════════════════════════════════════════════════════════════════════════════
# CLAUDE FLEET TMUX CONFIGURATION
# ═══════════════════════════════════════════════════════════════════════════════
# A premium tmux theme with real-time Claude Fleet status integration
# 
# Features:
#   - Real-time worker count and status
#   - Active task display
#   - Fleet server health indicator
#   - Gradient theme matching Fleet branding
#
# Installation:
#   ./config/install-tmux-theme.sh --fleet
#
# Requirements:
#   - tmux 3.0+
#   - Claude Fleet running (fleet server)
#   - curl (for API calls)
# ═══════════════════════════════════════════════════════════════════════════════

# ─────────────────────────────────────────────────────────────────────────────
# CORE SETTINGS
# ─────────────────────────────────────────────────────────────────────────────

# Enable true color support
set -g default-terminal "tmux-256color"
set -ga terminal-overrides ",xterm-256color:Tc"

# Enable mouse support
set -g mouse on

# Start windows and panes at 1
set -g base-index 1
setw -g pane-base-index 1

# Renumber windows when one is closed
set -g renumber-windows on

# Increase history limit
set -g history-limit 50000

# Reduce escape time for vim
set -sg escape-time 0

# Enable focus events
set -g focus-events on

# ─────────────────────────────────────────────────────────────────────────────
# KEY BINDINGS
# ─────────────────────────────────────────────────────────────────────────────

# Change prefix to Ctrl-a
unbind C-b
set -g prefix C-a
bind C-a send-prefix

# Reload config
bind r source-file ~/.tmux.conf \; display-message "Config reloaded!"

# Split panes with | and -
bind | split-window -h -c "#{pane_current_path}"
bind - split-window -v -c "#{pane_current_path}"

# Vim-style pane navigation
bind h select-pane -L
bind j select-pane -D
bind k select-pane -U
bind l select-pane -R

# Resize panes with Shift+arrows
bind -r H resize-pane -L 5
bind -r J resize-pane -D 5
bind -r K resize-pane -U 5
bind -r L resize-pane -R 5

# New window in current path
bind c new-window -c "#{pane_current_path}"

# ─────────────────────────────────────────────────────────────────────────────
# FLEET STATUS SCRIPTS
# ─────────────────────────────────────────────────────────────────────────────

# Fleet status check script (creates if not exists)
run-shell 'mkdir -p ~/.tmux/scripts'

run-shell 'cat > ~/.tmux/scripts/fleet-status.sh << "SCRIPT"
#!/bin/bash
# Claude Fleet Status for tmux

FLEET_PORT="${FLEET_PORT:-3000}"
FLEET_URL="http://localhost:${FLEET_PORT}"

# Check if fleet server is running
if ! curl -s "${FLEET_URL}/health" > /dev/null 2>&1; then
    echo "#[fg=#666666]FLEET OFFLINE"
    exit 0
fi

# Get worker stats
STATS=$(curl -s "${FLEET_URL}/api/workers" 2>/dev/null)

if [ -z "$STATS" ]; then
    echo "#[fg=#ff6b6b]ERR"
    exit 0
fi

# Parse worker counts
TOTAL=$(echo "$STATS" | grep -o '"id"' | wc -l | tr -d " ")
ACTIVE=$(echo "$STATS" | grep -o '"status":"active"' | wc -l | tr -d " ")
IDLE=$(echo "$STATS" | grep -o '"status":"idle"' | wc -l | tr -d " ")

# Color based on status
if [ "$ACTIVE" -gt 0 ]; then
    COLOR="#00d4ff"
    ICON="λ"
elif [ "$TOTAL" -gt 0 ]; then
    COLOR="#9966ff"
    ICON="○"
else
    COLOR="#666666"
    ICON="·"
fi

echo "#[fg=${COLOR},bold]${ICON} ${ACTIVE}#[fg=#888888]/${TOTAL}"
SCRIPT
chmod +x ~/.tmux/scripts/fleet-status.sh'

run-shell 'cat > ~/.tmux/scripts/fleet-tasks.sh << "SCRIPT"
#!/bin/bash
# Claude Fleet Active Tasks for tmux

FLEET_PORT="${FLEET_PORT:-3000}"
FLEET_URL="http://localhost:${FLEET_PORT}"

# Check if fleet server is running
if ! curl -s "${FLEET_URL}/health" > /dev/null 2>&1; then
    exit 0
fi

# Get active tasks
TASKS=$(curl -s "${FLEET_URL}/api/tasks?status=active" 2>/dev/null)

if [ -z "$TASKS" ]; then
    exit 0
fi

# Count active tasks
COUNT=$(echo "$TASKS" | grep -o '"id"' | wc -l | tr -d " ")

if [ "$COUNT" -gt 0 ]; then
    echo "#[fg=#00d4ff]T:${COUNT}"
fi
SCRIPT
chmod +x ~/.tmux/scripts/fleet-tasks.sh'

run-shell 'cat > ~/.tmux/scripts/fleet-swarm.sh << "SCRIPT"
#!/bin/bash
# Claude Fleet Swarm Status for tmux

FLEET_PORT="${FLEET_PORT:-3000}"
FLEET_URL="http://localhost:${FLEET_PORT}"

# Check if fleet server is running
if ! curl -s "${FLEET_URL}/health" > /dev/null 2>&1; then
    exit 0
fi

# Get active swarms
SWARMS=$(curl -s "${FLEET_URL}/api/swarms?status=active" 2>/dev/null)

if [ -z "$SWARMS" ]; then
    exit 0
fi

# Count active swarms
COUNT=$(echo "$SWARMS" | grep -o '"id"' | wc -l | tr -d " ")

if [ "$COUNT" -gt 0 ]; then
    echo "#[fg=#9966ff]S:${COUNT}"
fi
SCRIPT
chmod +x ~/.tmux/scripts/fleet-swarm.sh'

# ─────────────────────────────────────────────────────────────────────────────
# COLOR PALETTE (Claude Fleet Brand)
# ─────────────────────────────────────────────────────────────────────────────

# Primary: Cyan (#00d4ff)
# Secondary: Blue (#0066ff)  
# Accent: Purple (#9966ff)
# Background: Dark (#12121a)
# Text: Light (#e0e0e0)

# ─────────────────────────────────────────────────────────────────────────────
# STATUS BAR CONFIGURATION
# ─────────────────────────────────────────────────────────────────────────────

set -g status on
set -g status-interval 5
set -g status-position bottom
set -g status-justify left

# Status bar colors
set -g status-style "bg=#12121a,fg=#e0e0e0"

# Status bar length
set -g status-left-length 100
set -g status-right-length 150

# ─────────────────────────────────────────────────────────────────────────────
# LEFT STATUS: Session + Fleet Status
# ─────────────────────────────────────────────────────────────────────────────

set -g status-left "\
#[fg=#12121a,bg=#00d4ff,bold]  #S \
#[fg=#00d4ff,bg=#0066ff]\
#[fg=#12121a,bg=#0066ff,bold] #{?client_prefix,CMD,λ} \
#[fg=#0066ff,bg=#9966ff]\
#[fg=#12121a,bg=#9966ff] #(~/.tmux/scripts/fleet-status.sh) \
#[fg=#9966ff,bg=#12121a] "

# ─────────────────────────────────────────────────────────────────────────────
# RIGHT STATUS: Tasks + Swarms + Time
# ─────────────────────────────────────────────────────────────────────────────

set -g status-right "\
#(~/.tmux/scripts/fleet-tasks.sh) \
#(~/.tmux/scripts/fleet-swarm.sh) \
#[fg=#333344]\
#[fg=#888888,bg=#333344] %H:%M \
#[fg=#0066ff,bg=#333344]\
#[fg=#12121a,bg=#0066ff,bold] %b %d \
#[fg=#00d4ff,bg=#0066ff]\
#[fg=#12121a,bg=#00d4ff,bold]  #H "

# ─────────────────────────────────────────────────────────────────────────────
# WINDOW STATUS
# ─────────────────────────────────────────────────────────────────────────────

# Window separator
setw -g window-status-separator ""

# Inactive windows
setw -g window-status-format "\
#[fg=#12121a,bg=#222233]\
#[fg=#888888,bg=#222233] #I \
#[fg=#666666]#W \
#[fg=#222233,bg=#12121a]"

# Active window
setw -g window-status-current-format "\
#[fg=#12121a,bg=#00d4ff]\
#[fg=#12121a,bg=#00d4ff,bold] #I \
#[fg=#12121a]#W \
#[fg=#00d4ff,bg=#12121a]"

# ─────────────────────────────────────────────────────────────────────────────
# PANE BORDERS
# ─────────────────────────────────────────────────────────────────────────────

set -g pane-border-style "fg=#333344"
set -g pane-active-border-style "fg=#00d4ff"

# Pane indicator
set -g display-panes-colour "#333344"
set -g display-panes-active-colour "#00d4ff"

# ─────────────────────────────────────────────────────────────────────────────
# MESSAGE & COMMAND STYLING
# ─────────────────────────────────────────────────────────────────────────────

set -g message-style "bg=#00d4ff,fg=#12121a,bold"
set -g message-command-style "bg=#9966ff,fg=#12121a,bold"

# ─────────────────────────────────────────────────────────────────────────────
# CLOCK MODE
# ─────────────────────────────────────────────────────────────────────────────

setw -g clock-mode-colour "#00d4ff"
setw -g clock-mode-style 24

# ─────────────────────────────────────────────────────────────────────────────
# COPY MODE
# ─────────────────────────────────────────────────────────────────────────────

setw -g mode-style "bg=#0066ff,fg=#e0e0e0"

# Use vim keybindings in copy mode
setw -g mode-keys vi
bind -T copy-mode-vi v send -X begin-selection
bind -T copy-mode-vi y send -X copy-selection-and-cancel

# ─────────────────────────────────────────────────────────────────────────────
# PLUGIN MANAGER (TPM)
# ─────────────────────────────────────────────────────────────────────────────

# List of plugins
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sensible'
set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @plugin 'tmux-plugins/tmux-continuum'

# Resurrect settings
set -g @resurrect-capture-pane-contents 'on'
set -g @continuum-restore 'on'

# Initialize TPM (keep at bottom)
run '~/.tmux/plugins/tpm/tpm'
